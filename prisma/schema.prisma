// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

 datasource db {
   provider = "postgresql"
   url = env("POSTGRES_PRISMA_URL") // uses connection pooling
   directUrl = env("POSTGRES_URL_NON_POOLING") // uses a direct connection
 }

model Banco {
  id                    String              @id @default(uuid())
  nombre                String              @unique @db.VarChar(128)
  deleted               DateTime?
  cuentas               CuentaBancaria[]
  cheques               Cheque[]
}


model CuentaBancaria {
  id                    String             @id @default(uuid())
  numeroCuenta          String             @unique @db.VarChar(128)
  banco                 Banco              @relation(fields: [bancoId], references: [id], onDelete: NoAction)
  bancoId               String
  entidad               Entidad            @relation(fields: [entidadId], references: [id], onDelete: NoAction)
  entidadId             String 
  esCuentaAhorro        Boolean
  saldo                 Decimal            @db.Money
  saldoDisponible       Decimal            @db.Money
  deleted               DateTime?
  operaciones           Operacion[]
  cheques               Cheque[]

  createdAt                  DateTime         @default(now())
  updatedAt                  DateTime         @updatedAt @default(now())
}


model Entidad {
  id                    String              @id @default(uuid())
  nombre                String              @unique @db.VarChar(128)
  ruc                   String              @unique @db.VarChar(128)
  cuentaBancarias       CuentaBancaria[]
}


model TipoOperacion {
  id                    String              @id @default(uuid())
  nombre                String              @unique
  esDebito              Boolean             
  
  afectaSaldo           Boolean
  afectaSaldoDisponible Boolean

  operaciones           Operacion[]

  deleted               DateTime?
}


model Operacion {
  id                  String                @id @default(uuid())
  tipoOperacion       TipoOperacion         @relation(fields: [tipoOperacionId], references: [id], onDelete: NoAction)
  tipoOperacionId     String                
  fechaOperacion      DateTime              @default(now())
  monto               Decimal               @db.Money
 
  cuentaBancariaOrigen CuentaBancaria       @relation(fields: [cuentaBancariaOrigenId], references: [id], onDelete: NoAction)
  cuentaBancariaOrigenId String

  bancoInvolucrado    String?               @db.VarChar(128)
  nombreInvolucrado   String                @db.VarChar(128)
  cuentaInvolucrado   String?               @db.VarChar(128)
  rucInvolucrado      String?               @db.VarChar(128)

  concepto            String               @db.VarChar(255)

  numeroComprobante   String               @db.VarChar(128)

  cheque              Cheque[]

  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt @default(now())
}

enum estadoCheque {
  EMITIDO
  PAGADO
  ANULADO
  PENDIENTE
}

model Cheque {
  id                        String           @id @default(uuid())
  numeroCheque              String           @unique
  esRecibido                Boolean               
  monto                     Decimal          @db.Money        
  
  fechaEmision              DateTime
  fechaPago                 DateTime?

  involucrado               String @db.VarChar(128)

  estado                    estadoCheque     @default(EMITIDO)
  
  bancoCheque               Banco            @relation(references: [id], fields: [bancoChequeId], onDelete: NoAction)
  bancoChequeId             String

  operacion                 Operacion        @relation(references: [id], fields: [operacionId], onDelete: NoAction)
  operacionId               String
  
  cuentaAfectada            CuentaBancaria   @relation(fields: [cuentaBancariaAfectadaId], references: [id], onDelete: NoAction)
  cuentaBancariaAfectadaId  String

  createdAt                 DateTime         @default(now())
  updatedAt                 DateTime         @updatedAt @default(now())
}

enum Roles { 
  ADMIN
  EMPLOYEES
}

model User {
  id            String @id @default(uuid())
  
  nombre        String @db.VarChar(128)
  apellido      String @db.VarChar(128)

  username      String @unique @db.VarChar(128)
  docIdentidad  String @unique @db.VarChar(128)

  password      String

  rol           Roles @default(EMPLOYEES)

  aperturas     AperturaCaja[]	

  deleted       DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt @default(now())
}

//************************** CAJA **********************************

model Caja {
  id        String @id @default(uuid())
  numero    Int @db.Integer @unique
  
  aperturas AperturaCaja[]

  deleted   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AperturaCaja {
  id          String @id @default(uuid())
  
  caja        Caja  @relation(references: [id], fields: [cajaId], onDelete: NoAction)
  cajaId      String

  cajero      User  @relation(references: [id], fields: [cajeroId], onDelete: NoAction)
  cajeroId    String 

  movimiento Movimiento[]
  arqueo     ArqueoDeCaja[]

  apertura     DateTime @default(now())

  saldoInicial Decimal @db.Money

  cierreCaja   DateTime?

  observaciones String?

  deleted   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Cliente {
  id           String @id @default(uuid())
  
  nombre       String @db.VarChar(128)
  docIdentidad String @db.VarChar(128)
  
  deleted   DateTime?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ArqueoDeCaja {
  id        String @id @default(uuid())

  apertura  AperturaCaja @relation(references: [id], fields: [aperturaId], onDelete: NoAction)
  aperturaId String

  montoRegistrado Decimal @db.Money
  montoEsperado   Decimal @db.Money

  deleted   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum medioDePago {
  EFECTIVO
  CHEQUE
  TARJETA
}

model Movimiento{
  id                  String @id @default(uuid())
  
  apertura            AperturaCaja    @relation(references: [id], fields: [aperturaId], onDelete: NoAction)
  aperturaId          String

  monto               Decimal @db.Money

  recibosDetalles     ReciboDetalle[]
  movimientoDetalles  MovimientoDetalle[]
  comprobantes        Comprobante[]

  esIngreso           Boolean

  deleted             DateTime?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model MovimientoDetalle {
  id        String @id @default(uuid())
  
  movimiento     Movimiento @relation(references: [id], fields: [movimientoId], onDelete: NoAction)
  movimientoId   String

  monto          Decimal @db.Money

  metodoPago     medioDePago @default(EFECTIVO)

  chequeCaja    ChequeCaja[]
  tarjeta       Tarjeta[] 

  deleted       DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Factura {
  id        String @id @default(uuid())
  
  ruc       String @db.VarChar(128)
  nombre    String @db.VarChar(128)
  esContado Boolean

  total       Decimal @db.Money
  ivaTotal    Decimal  @db.Money

  facturaDetalles FacturaDetalles[]
  recibos Recibos?

  deleted   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FacturaDetalles {
  id          String @id @default(uuid())
  
  factura     Factura @relation(references: [id], fields: [facturaId], onDelete: NoAction)
  facturaId   String

  producto    Producto @relation(references: [id], fields: [productoId], onDelete: NoAction)
  productoId  String

  costoUnit   Decimal @db.Money
  cantidad    Int

  monto       Decimal @db.Money
  ivaPorcent  Float?
  iva         Decimal @db.Money

  deleted     DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Recibos {
  id          String @id @default(uuid())
  
  ruc         String @db.VarChar(128)
  nombre      String @db.VarChar(128)
  
  factura     Factura @relation(references: [id], fields: [facturaId], onDelete: NoAction)
  facturaId   String @unique

  totalPagado Decimal @db.Money

  estaPagado  Boolean

  recibosDetalles ReciboDetalle[]

  deleted   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ReciboDetalle {
  id        String @id @default(uuid())
  
  monto     Decimal @db.Money

  recibo    Recibos @relation(references: [id], fields: [reciboId], onDelete: NoAction)
  reciboId  String

  movimiento Movimiento @relation(references: [id], fields: [movimientoId], onDelete: NoAction)
  movimientoId String

  deleted   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Producto {
  id        String @id @default(uuid())
  
  nombre    String @db.VarChar(128)
  precio    Decimal @db.Money
  iva       Float?

  facturaDetalles FacturaDetalles[]

  deleted   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Comprobante {
  id            String @id @default(uuid())

  concepto      String
  monto         Decimal @db.Money
  docIdentidad  String @db.VarChar(128)
  nombre        String @db.VarChar(128)

  movimiento    Movimiento @relation(references: [id], fields: [movimientoId], onDelete: NoAction)
  movimientoId  String

  deleted   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ChequeCaja {
  id            String @id @default(uuid())
  numeroCheque  String @unique
  librador      String @db.VarChar(128)

  movimientoDetalles MovimientoDetalle @relation(references: [id], fields: [movimientoId], onDelete: NoAction)
  movimientoId       String

  deleted   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tarjeta {
  id            String @id @default(uuid())
  esCredito     Boolean
  numeroTarjeta String @unique
  exp           DateTime
  cvv           String
  nombre        String @db.VarChar(128)

  movimientoDetalles MovimientoDetalle @relation(references: [id], fields: [movimientoId], onDelete: NoAction)
  movimientoId       String

  deleted   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}